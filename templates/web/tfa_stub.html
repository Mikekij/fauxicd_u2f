{% extends 'base.html' %}

{% block title %}MedCrypt - FauxICD | Login{% endblock %}

{% block body_block %}

<script>
//make challenge register request

//when the page is loaded, I need to have made a request to the U2F server to get the chanllenge code.
//The result of this request should look like this:
//{"authenticateRequests":[],"registerRequests":[{"challenge":"GEKC8Yvtpen6mTs4beBvC2N0RhZaJw5GTZbXIxTI9rs","appId":"https://localhost:8443","version":"U2F_V2"}]};
//this ajax request is failing with:
//https://localhost:8001/enroll?callback=jQuery2140391487275948748_1441912662048&_=1441912662049 net::ERR_CONNECTION_REFUSED
//I'm also getting a "U2F failed with error: 2" error, meaning the app_id is wrong.
// I'm not sure how this relates: https://developers.yubico.com/U2F/App_ID.html

var request = $.ajax({
            url: "https://localhost:8001/enroll",
            dataType: "jsonp",
            success: function (data) {
              console.log(data)
              alert(data);
            }
          });


  setTimeout(function() {
      u2f.register(request.registerRequests, request.authenticateRequests,
      function(data) {
          var form = document.getElementById('form');
          var reg = document.getElementById('tokenResponse');
          if(data.errorCode) {
              alert("U2F failed with error: " + data.errorCode);
              return;
          }
          reg.value=JSON.stringify(data);
          form.submit();
      });
  }, 1000);
</script>

<div class=row>
  <div class="col-12-md">
    <p>Touch your U2F token.</p>
        <form method="POST" action="finishRegistration" id="form" onsubmit="return false;">
            <input type="hidden" name="username" value="${username}"/>
            <input type="hidden" name="tokenResponse" id="tokenResponse"/>
        </form>
  </div><!-- /.col-12-md -->
</div><!-- /.row -->



{% endblock %}
