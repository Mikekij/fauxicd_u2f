{% extends 'base.html' %}

{% block title %}MedCrypt - FauxICD | Login{% endblock %}

{% block body_block %}

<script>
//make challenge register request

//when the page is loaded, I need to have made a request to the U2F server to get the chanllenge code.
//The result of this request should look like this:
//{"authenticateRequests":[],"registerRequests":[{"challenge":"GEKC8Yvtpen6mTs4beBvC2N0RhZaJw5GTZbXIxTI9rs","appId":"https://localhost:8443","version":"U2F_V2"}]};
//this ajax request is failing with:
//https://localhost:8001/enroll?callback=jQuery2140391487275948748_1441912662048&_=1441912662049 net::ERR_CONNECTION_REFUSED
//I'm also getting a "U2F failed with error: 2" error, meaning the app_id is wrong.
// I'm not sure how this relates: https://developers.yubico.com/U2F/App_ID.html

$(document).ready(function(){
  $('#myModal').modal('show')
});

// render requests from server into Javascript format
  var registerRequests = <%= @registration_requests.as_json.to_json.html_safe %>;
  var registerRequests = { registration_requests };

  var signRequests = <%= @sign_requests.as_json.to_json.html_safe %>;

  u2f.register(registerRequests, signRequests, function(registerResponse) {
    var form, reg;
  //  alert(registerResponse.errorCode);

    if (registerResponse.errorCode) {
      if (registerResponse.errorCode == "4"){
        return alert("This key has already been registered within Medcrypt. Try another key.")
      }
      else {
          return alert("Registration error: " + registerResponse.errorCode);
      };
    };

    form = document.forms[0];
    response = document.querySelector('[name=response]');

    response.value = JSON.stringify(registerResponse);

    form.submit();
  },15);

url = "https://0.0.0.0:3000/new_registration?format=json";
var data;

var request = $.getJSON(url,function(data) {
      alert(data["challenge"]);
    });

  setTimeout(function() {
      u2f.register(request.registerRequests, request.authenticateRequests,
      function(register_data) {
          var form = document.getElementById('form');
          var reg = document.getElementById('tokenResponse');
          if(register_data.errorCode) {
              alert("U2F failed with error: " + register_data.errorCode);
              return;
          }
          reg.value=JSON.stringify(register_data);
          form.submit();
      });
  }, 1000);

</script>

<div class=row>
  <div class="col-12-md">
    <p>Touch your U2F token.</p>
        <form method="POST" action="/create_tfa_registration" id="form" >
            <input type="hidden" name="username" value="${username}"/>
            <input type="hidden" name="response">
            <input type="hidden" name="tokenResponse" id="tokenResponse"/>
        </form>
  </div><!-- /.col-12-md -->
</div><!-- /.row -->



{% endblock %}
